"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function generateWrapperCode(e,n){var r=(e.epsagon||{}).wrapper;r||(r=DEFAULT_WRAPPERS[e.language]);var t="python"===e.language?e.relativePath.replace(/\//g,".").replace(/\\/g,"."):e.relativePath;return WRAPPER_CODE[e.language].replace(/RELATIVE_PATH/g,t).replace(/METHOD/g,e.method).replace(/WRAPPER_TYPE/g,r).replace(/TOKEN/g,n.token).replace(/APP_NAME/g,n.appName).replace(/COLLECTOR_URL/g,n.collectorURL?`'${n.collectorURL}'`:void 0).replace(/METADATA_ONLY/g,!0===n.metadataOnly?"1":"0")}function generateWrapperExt(e){return FILE_NAME_BY_LANG_GENERATORS[e.language](e.epsagonHandler)}var _slicedToArray=_interopDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck=_interopDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass=_interopDefault(require("@babel/runtime/helpers/createClass")),_regeneratorRuntime=_interopDefault(require("@babel/runtime/regenerator")),_asyncToGenerator=_interopDefault(require("@babel/runtime/helpers/asyncToGenerator")),fs=_interopDefault(require("fs-extra")),path=require("path"),util=require("util"),_=_interopDefault(require("lodash")),glob=_interopDefault(require("glob-promise")),DEFAULT_WRAPPERS={python:"lambda_wrapper",node:"lambdaWrapper",tsnode:"lambdaWrapper"},WRAPPER_CODE={python:`\nimport epsagon\nfrom RELATIVE_PATH import METHOD as METHOD_internal\n\nnull = None  # used to ignore arguments\nundefined = None  # used to igone arguments\nepsagon.init(\n    token='TOKEN',\n    app_name='APP_NAME',\n    collector_url=COLLECTOR_URL,\n    metadata_only=bool(METADATA_ONLY)\n)\n\nMETHOD = epsagon.WRAPPER_TYPE(METHOD_internal)\n`,node:`\nconst epsagon = require('epsagon');\nconst handler = require('../RELATIVE_PATH.js');\n\nepsagon.init({\n    token: 'TOKEN',\n    appName: 'APP_NAME',\n    collectorURL: COLLECTOR_URL,\n    metadataOnly: Boolean(METADATA_ONLY)\n});\n\nexports.METHOD = epsagon.WRAPPER_TYPE(handler.METHOD);\n`,tsnode:`\nvar epsagon = require('epsagon');\nvar handler = require('../RELATIVE_PATH');\n\nepsagon.init({\n    token: 'TOKEN',\n    appName: 'APP_NAME',\n    collectorURL: COLLECTOR_URL,\n    metadataOnly: Boolean(METADATA_ONLY)\n});\n\nexports.METHOD = epsagon.WRAPPER_TYPE(handler.METHOD);\n`},FILE_NAME_BY_LANG_GENERATORS={python:function(e){return`${e}.py`},node:function(e){return`${e}.js`},tsnode:function(e){return`${e}.ts`}},SUPPORTED_LANGUAGES=Object.keys(WRAPPER_CODE),mkdir=util.promisify(fs.mkdir),writeFile=util.promisify(fs.writeFile),VALIDATE_LIB_BY_LANG={python(){this.log("You have some Python Lambda functions. Please make sure Epsagon's Python library is installed.")},node(){var e=this;return _asyncToGenerator(_regeneratorRuntime.mark(function n(){var r,t,a,i;return _regeneratorRuntime.wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,fs.readJson(path.join(e.prefix,"package.json"));case 3:r=n.sent,n.next=10;break;case 6:return n.prev=6,n.t0=n.catch(0),e.log("Could not read package.json. Skipping Epsagon library validation - please make sure you have it installed!"),n.abrupt("return");case 10:if(t=r,a=t.dependencies,i=void 0===a?[]:a,Object.keys(i).some(function(e){return"epsagon"===e})){n.next=13;break}throw new Error("Epsagon's Node library must be installed in order to use this plugin!");case 13:case"end":return n.stop()}},n,this,[[0,6]])}))()}};VALIDATE_LIB_BY_LANG.tsnode=VALIDATE_LIB_BY_LANG.node;var ServerlessEpsagonPlugin=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;_classCallCheck(this,e),this.sls=n,this.prefix=r.prefix||this.sls.config.servicePath||process.env.npm_config_prefix,this.funcs=[],this.originalServicePath=this.sls.config.servicePath,this.commands={epsagon:{usage:"Automatically wraps your function handlers with Epsagon.",lifecycleEvents:["run","clean"],commands:{clean:{usage:"Cleans up extra Epsagon files if necessary",lifecycleEvents:["init"]}}}},this.hooks={"before:package:createDeploymentArtifacts":this.run.bind(this),"before:deploy:function:packageFunction":this.run.bind(this),"before:invoke:local:invoke":this.run.bind(this),"before:offline:start:init":this.run.bind(this),"before:step-functions-offline:start":this.run.bind(this),"after:package:createDeploymentArtifacts":this.cleanup.bind(this),"after:invoke:local:invoke":this.cleanup.bind(this),"epsagon:clean:init":this.cleanup.bind(this)}}return _createClass(e,[{key:"log",value:function(e){for(var n,r=arguments.length,t=new Array(r>1?r-1:0),a=1;a<r;a++)t[a-1]=arguments[a];(n=this.sls.cli).log.apply(n,[`[serverless-plugin-epsagon] ${e}`].concat(t))}},{key:"run",value:function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.config().disable){e.next=3;break}return this.log("Epsagon disabled - not wrapping functions"),e.abrupt("return");case 3:if(this.config().token){e.next=6;break}return this.log("No epsagon token was supplied - not wrapping functions"),e.abrupt("return");case 6:return this.log("Wrapping your functions with Epsagon..."),fs.removeSync(path.join(this.originalServicePath,this.config().handlersDirName)),this.funcs=this.findFuncs(),e.next=11,this.handleTS();case 11:return e.next=13,this.validateLib();case 13:return e.next=15,this.generateHandlers();case 15:this.assignHandlers();case 16:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"validateLib",value:function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var n,r=this;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=_.uniq(this.funcs.map(function(e){return e.language})),e.next=3,Promise.all(n.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(n){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,VALIDATE_LIB_BY_LANG[n].bind(r)();case 2:case"end":return e.stop()}},e,this)}));return function(n){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"handleTS",value:function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(){return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(this.funcs.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(n){var r,t,a;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=_.isString(n.handler)?n.handler.split("."):[],t=r.slice(0,-1).join("."),(a=glob.sync(`${t}.*`)).length>0&&(a[0].endsWith(".ts")||a[0].endsWith(".tsx"))&&(n.language="tsnode");case 4:case"end":return e.stop()}},e,this)}));return function(n){return e.apply(this,arguments)}}()));case 2:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"findFuncs",value:function(){var e=this;return Object.entries(this.sls.service.functions).reduce(function(n,r){var t=_slicedToArray(r,2),a=t[0],i=t[1],s=i.runtime||e.sls.service.provider.runtime,o=(i.epsagon||{}).disable,u=_.isString(i.handler)?i.handler.split("."):[],c=u.slice(0,-1).join(".");if(o)return e.log(`Epsagon is disabled for function ${a}, skipping.`),n;if(!_.isString(s))return n;var l=SUPPORTED_LANGUAGES.find(function(e){return s.match(e)});return l?(n.push(Object.assign(i,{method:_.last(u),key:a,relativePath:c,language:l,epsagonHandler:`${a}-epsagon`})),n):(e.log(`Runtime "${s}" is not supported yet, skipping function ${a}`),n)},[])}},{key:"generateHandlers",value:function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(){var n,r=this;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=path.join(this.originalServicePath,this.config().handlersDirName),e.prev=1,e.next=4,mkdir(n);case 4:e.next=10;break;case 6:if(e.prev=6,e.t0=e.catch(1),"EEXIST"===e.t0.code){e.next=10;break}throw e.t0;case 10:return e.next=12,Promise.all(this.funcs.map(function(){var e=_asyncToGenerator(_regeneratorRuntime.mark(function e(t){var a;return _regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=generateWrapperCode(t,r.config()),e.next=3,writeFile(path.join(n,generateWrapperExt(t)),a);case 3:case"end":return e.stop()}},e,this)}));return function(n){return e.apply(this,arguments)}}()));case 12:case"end":return e.stop()}},e,this,[[1,6]])}));return function(){return e.apply(this,arguments)}}()},{key:"assignHandlers",value:function(){var e=this;this.funcs.forEach(function(n){_.set(e.sls.service.functions,`${n.key}.handler`,`${e.config().handlersDirName.replace("\\","/")}/${n.epsagonHandler}.${n.method}`)})}},{key:"config",value:function(){return Object.assign({metadataOnly:"false",handlersDirName:"epsagon_handlers"},(this.sls.service.custom||{}).epsagon||{})}},{key:"cleanup",value:function(){this.log("Cleaning up Epsagon's handlers"),fs.removeSync(path.join(this.originalServicePath,this.config().handlersDirName))}}]),e}();module.exports=ServerlessEpsagonPlugin;
